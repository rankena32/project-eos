<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Naujas veikėjas – Project Eos</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .card{max-width:420px;margin:6vh auto;background:#1b2130;border:1px solid #263046;border-radius:14px;padding:18px}
    .h{margin:0 0 10px;font:600 20px/1.3 system-ui;color:#e7ecf5}
    label{display:block;margin:10px 0 6px;color:#cfe3ff;font-size:14px}
    input[type="text"],select{
      width:100%;padding:10px;border-radius:10px;border:1px solid #263046;background:#0e1420;color:#e7ecf5
    }
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #263046;background:#2a2f3d;color:#e7ecf5;cursor:pointer}
    .btn.primary{background:#2a6a2a}
    .err{color:#ff6b6b;font-size:13px;margin-top:8px;min-height:18px}
  </style>
</head>
<body>
  <div class="card">
    <h1 class="h">Sukurti veikėją</h1>
    <form id="charForm" novalidate>
      <label for="name">Vardas</label>
      <input id="name" type="text" maxlength="32" placeholder="Herojus" required>

      <label for="gender">Lytis</label>
      <select id="gender">
        <option value="m">Vyras</option>
        <option value="f">Moteris</option>
        <option value="x" selected>Nenurodyta</option>
      </select>

      <div style="margin-top:12px">
        <button class="btn" type="button" onclick="history.back()">Atgal</button>
        <button class="btn primary" type="submit">Sukurti</button>
      </div>
      <div id="msg" class="err"></div>
    </form>
  </div>
  <script>
    (function(){
      const form = document.getElementById('charForm');
      const name = document.getElementById('name');
      const gender = document.getElementById('gender');
      const msg = document.getElementById('msg');

      function showErr(t){ msg.textContent = t || ''; }

      async function api(url, method='GET', body){
        const res = await fetch(url, {
          method, credentials:'include',
          headers: {'Content-Type':'application/json'},
          body: body ? JSON.stringify(body) : undefined
        });
        const j = await res.json().catch(()=>({error:'bad_json'}));
        return { status: res.status, body: j };
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const vName = name.value.trim();
        if (!vName) return showErr('Įvesk vardą.');
        const { status, body } = await api('/api/character.php?action=create', 'POST', {
          name: vName, gender: gender.value, slot: 1
        });
        if (status === 201 && body?.ok) {
          // (nebūtina, bet galėtume iškart žymėti „aktyvų“)
          await api('/api/character.php?action=select','POST',{ character_id: body.character_id });
          window.location.href = '/'; // startuoja Canvas (scene_world patikrins /auth.php?action=me)
        } else {
          showErr(body?.error === 'slot_or_name_taken' ? 'Vardas ar slot’as užimtas.' : 'Nepavyko sukurti veikėjo.');
        }
      });
    })();
  </script>
</body>
</html>
